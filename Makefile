# Makefile –¥–ª—è Flask + Jinja2 –ø—Ä–æ–µ–∫—Ç–∞
# ---------------------------------------------------
# Targets:
#   venv     ‚Äî —Å–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
#   install  ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ requirements.txt
#   run      ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å dev-—Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 5006
#   freeze   ‚Äî –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
#   clean    ‚Äî —É–¥–∞–ª–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∫—ç—à
# ---------------------------------------------------

# Shell
SHELL := /bin/bash

# –ò–º—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
VENV := .venv

# Python-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä –≤–Ω—É—Ç—Ä–∏ venv
PY := $(VENV)/bin/python
PIP := $(VENV)/bin/pip
FLASK := $(VENV)/bin/flask

# –§–∞–π–ª —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
REQ := requirements.txt

.PHONY: all venv install run freeze clean

all: venv install run

venv:
	@echo "‚öôÔ∏è  –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ $(VENV)..."
	@test -d $(VENV) || python3 -m venv $(VENV)
	@echo "‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ."

install: venv
	@echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ $(REQ)..."
	$(PIP) install --upgrade pip
	$(PIP) install -r $(REQ)
	@echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."

run: install
	@echo "üöÄ –ó–∞–ø—É—Å–∫ Flask –Ω–∞ –ø–æ—Ä—Ç—É 5006..."
	# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
	FLASK_APP=app.py \
	FLASK_ENV=development \
	FLASK_RUN_PORT=5006 \
	$(FLASK) run

freeze: venv
	@echo "üìù –ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ $(REQ)..."
	$(PIP) freeze > $(REQ)
	@echo "‚úÖ $(REQ) –æ–±–Ω–æ–≤–ª—ë–Ω."

clean:
	@echo "üßπ –£–¥–∞–ª—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∫—ç—à..."
	rm -rf $(VENV) __pycache__ .pytest_cache
	find . -type d -name "__pycache__" -exec rm -rf {} +
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
