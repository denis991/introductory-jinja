# Makefile –¥–ª—è Flask + Jinja2 –ø—Ä–æ–µ–∫—Ç–∞
# ---------------------------------------------------
# Targets:
#   venv     ‚Äî —Å–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
#   install  ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ requirements.txt
#   run      ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å dev-—Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 5006
#   kill-port ‚Äî —É–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø–æ—Ä—Ç—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5006)
#   kill-all-ports ‚Äî —É–±–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –≤—Å–µ—Ö –ø–æ—Ä—Ç–∞—Ö
#   freeze   ‚Äî –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
#   clean    ‚Äî —É–¥–∞–ª–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∫—ç—à
# ---------------------------------------------------

# Shell
SHELL := /bin/bash

# –ò–º—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
VENV := .venv

# Python-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä –≤–Ω—É—Ç—Ä–∏ venv
PY := $(VENV)/bin/python
PIP := $(VENV)/bin/pip
FLASK := $(VENV)/bin/flask

# –§–∞–π–ª —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
REQ := requirements.txt

# –ü–æ—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
DEFAULT_PORT := 5006

.PHONY: all venv install run kill-port kill-all-ports freeze clean

all: venv install run

venv:
	@echo "‚öôÔ∏è  –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ $(VENV)..."
	@test -d $(VENV) || python3 -m venv $(VENV)
	@echo "‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ."

install: venv
	@echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ $(REQ)..."
	$(PIP) install --upgrade pip
	$(PIP) install -r $(REQ)
	@echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."

kill-port:
	@echo "üî´ –û—á–∏—â–∞–µ–º –ø–æ—Ä—Ç $(or $(PORT),$(DEFAULT_PORT))..."
	@if lsof -ti:$(or $(PORT),$(DEFAULT_PORT)) > /dev/null 2>&1; then \
		echo "–ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É $(or $(PORT),$(DEFAULT_PORT)):"; \
		lsof -i:$(or $(PORT),$(DEFAULT_PORT)); \
		echo "–£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã..."; \
		lsof -ti:$(or $(PORT),$(DEFAULT_PORT)) | xargs kill -9; \
		echo "‚úÖ –ü–æ—Ä—Ç $(or $(PORT),$(DEFAULT_PORT)) –æ—á–∏—â–µ–Ω."; \
	else \
		echo "‚úÖ –ü–æ—Ä—Ç $(or $(PORT),$(DEFAULT_PORT)) —Å–≤–æ–±–æ–¥–µ–Ω."; \
	fi

kill-all-ports:
	@echo "üî´ –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ—Ä—Ç—ã..."
	@echo "–í–Ω–∏–º–∞–Ω–∏–µ! –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —É–±—å–µ—Ç –í–°–ï –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –í–°–ï–• –ø–æ—Ä—Ç–∞—Ö!"
	@echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é!"
	@read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo "–£–±–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö..."
	@for port in $$(lsof -ti:1-65535 2>/dev/null); do \
		echo "–£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å $$port"; \
		kill -9 $$port 2>/dev/null || true; \
	done
	@echo "‚úÖ –í—Å–µ –ø–æ—Ä—Ç—ã –æ—á–∏—â–µ–Ω—ã."

run: install kill-port
	@echo "üöÄ –ó–∞–ø—É—Å–∫ Flask –Ω–∞ –ø–æ—Ä—Ç—É $(DEFAULT_PORT)..."
	# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
	FLASK_APP=app.py \
	FLASK_ENV=development \
	FLASK_RUN_PORT=$(DEFAULT_PORT) \
	$(FLASK) run

freeze: venv
	@echo "üìù –ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ $(REQ)..."
	$(PIP) freeze > $(REQ)
	@echo "‚úÖ $(REQ) –æ–±–Ω–æ–≤–ª—ë–Ω."

clean:
	@echo "üßπ –£–¥–∞–ª—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∫—ç—à..."
	rm -rf $(VENV) __pycache__ .pytest_cache
	find . -type d -name "__pycache__" -exec rm -rf {} +
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
help:
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  make install        - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
	@echo "  make run           - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç –ø–æ—Ä—Ç 5006)"
	@echo "  make kill-port     - –û—á–∏—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç 5006 (–∏–ª–∏ —É–∫–∞–∑–∞—Ç—å PORT=8080)"
	@echo "  make kill-all-ports - –û—á–∏—Å—Ç–∏—Ç—å –í–°–ï –ø–æ—Ä—Ç—ã (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)"
	@echo "  make clean         - –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
	@echo ""
	@echo "–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:"
	@echo "  make kill-port PORT=8080  - –û—á–∏—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç 8080"
	@echo "  make kill-port            - –û—á–∏—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç 5006 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
